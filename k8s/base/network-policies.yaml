# Network Policies
# Enfoque simple de Zero Trust:
# 1. Primero negamos todo
# 2. Luego abrimos únicamente lo necesario
#
# Flujo esperado:
# Internet → api-gateway → user-service → redis

---
# Política base: deny all
# A partir de aquí nada entra ni sale si no está explícitamente permitido

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
spec:
  podSelector: {}   # Aplica a TODOS los pods del namespace
  policyTypes:
    - Ingress
    - Egress

---

# Permisos para el API Gateway
# - Recibe tráfico externo (ingress/port-forward)
# - Puede llamar al user-service
# - Necesita resolver DNS

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-api-gateway
spec:
  podSelector:
    matchLabels:
      app: api-gateway
  policyTypes:
    - Ingress
    - Egress

  ingress:
    - ports:
        - port: 3000   # Puerto donde escucha el gateway

  egress:
    
    # Permitir llamadas al user-service

    - to:
        - podSelector:
            matchLabels:
              app: user-service
      ports:
        - port: 3001

    # Permitir resolución DNS (CoreDNS)

    - to: []
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP

---
# Permisos para el User Service
# - Solo acepta tráfico desde el API Gateway
# - Puede conectarse a Redis
# - Necesita DNS

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-user-service
spec:
  podSelector:
    matchLabels:
      app: user-service
  policyTypes:
    - Ingress
    - Egress

  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: api-gateway
      ports:
        - port: 3001

  egress:
    # Permitir conexión a Redis

    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - port: 6379

    # Permitir DNS

    - to: []
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP

---
# Permisos para Redis
# Solo acepta tráfico desde user-service
# No necesita iniciar conexiones hacia fuera

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-redis
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
    - Ingress
    - Egress

  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: user-service
      ports:
        - port: 6379

  egress: []   # Redis no hace llamadas salientes

---
# Permitir que Prometheus scrapee métricas. Solo desde el namespace de monitoring o desde pods etiquetados como prometheus

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prometheus-scraping
spec:
  podSelector:
    matchLabels: {}   # Aplica a cualquier pod que exponga /metrics
  policyTypes:
    - Ingress

  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - port: 3000
        - port: 3001
