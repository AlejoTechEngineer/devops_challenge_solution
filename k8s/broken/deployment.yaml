# DESPLIEGUE ROTO A PROPÓSITO
# Este archivo está hecho con errores intencionales para practicar troubleshooting.
# La idea es que al aplicarlo, Kubernetes empiece a fallar por todos lados y se pueda identificar los problemas con `kubectl describe`, logs y eventos.
#
# Los detalles completos están explicados en: docs/troubleshooting.md

---
apiVersion: apps/v1
kind: Deploymentt          # BUG 1: typo intencional (debería ser Deployment)
metadata:
  name: api-gateway
  namespace: production

spec:
  replicas: 0              # BUG 2: con 0 réplicas no se levantará ningún pod

  selector:
    matchLabels:
      app: api-gateway

  template:
    metadata:
      labels:
        app: backend       # BUG 3: label incorrecto, no coincide con el selector

    spec:
      containers:
        - name: api-gateway

          # BUG 4: imagen sin registry → Kubernetes intentará buscarla en Docker Hub

          image: api-gateway:latest

          ports:
            
            # BUG 5: puerto incorrecto (la app escucha en 3000)

            - containerPort: 8080

          env:
            
            # BUG 6: nombre mal escrito del servicio upstream

            - name: USER_SERVICE_URL
              value: "http://userservice:3001"

          resources:
            requests:
              
              # BUG 7: requests absurdamente altos → pods quedarán en Pending

              cpu: "4000m"
              memory: "8Gi"

            limits:
              
              # BUG 8: limit menor que request → configuración inválida

              cpu: "100m"
              memory: "64Mi"

          livenessProbe:
            httpGet:
              
              # BUG 9: path y puerto incorrectos

              path: /healthz
              port: 8080

            initialDelaySeconds: 0

            # BUG 10: probes cada segundo → demasiado agresivo

            periodSeconds: 1

            # BUG 11: un fallo reinicia el contenedor inmediatamente

            failureThreshold: 1

---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
  namespace: production

spec:
  selector:
    
    # BUG 12: selector no coincide con los labels reales del pod

    app: gateway

  ports:
    - port: 80
      
      # BUG 5 repetido: targetPort equivocado

      targetPort: 8080

  type: LoadBalancer
