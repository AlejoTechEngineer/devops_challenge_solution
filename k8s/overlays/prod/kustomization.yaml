apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Namespace del entorno de producción
namespace: devops-challenge-prod

# Partimos de la base común y aplicamos ajustes específicos de prod

bases:
  - ../../base

# Configuración propia de producción
# Valores más estrictos y menos verbosos en logs

configMapGenerator:
  - name: app-config
    behavior: merge
    literals:
      - NODE_ENV=production
      - LOG_LEVEL=warn
      
      # Esta versión normalmente la sobreescribe el pipeline con el SHA real

      - APP_VERSION=1.0.0

patches:

  # En producción aumentamos réplicas para alta disponibilidad

  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: api-gateway
      spec:
        replicas: 3

  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: user-service
      spec:
        replicas: 3

  # HPA más amplio en producción para soportar picos de tráfico

  - patch: |-
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: api-gateway-hpa
      spec:
        minReplicas: 3
        maxReplicas: 15

  - patch: |-
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: user-service-hpa
      spec:
        minReplicas: 3
        maxReplicas: 12

  # En producción Redis usa almacenamiento persistente

  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: redis
      spec:
        template:
          spec:
            volumes:
              - name: redis-data
                persistentVolumeClaim:
                  claimName: redis-pvc

# En producción real no se gestionan secretos directamente aquí.
# Lo habitual sería:
# - External Secrets Operator + AWS Secrets Manager
# - Sealed Secrets en un flujo GitOps
#
# Este secretGenerator actúa como placeholder.
# El archivo secrets.env NO se sube al repositorio.
# Lo genera el pipeline a partir del gestor de secretos.

secretGenerator:
  - name: app-secrets
    behavior: replace
    envs:
      - secrets.env
    type: Opaque

# Recursos adicionales propios de prod
resources:
  - namespace.yaml
  - redis-pvc.yaml

